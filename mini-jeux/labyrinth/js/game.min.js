var Main = {};

Main.Boot = function (game) {
    this.game = game;
};

Main.Boot.prototype =
{
    preload: function () {
        this.stage.scaleMode = Phaser.StageScaleMode.SHOW_ALL;
        this.game.stage.scale.refresh();

        this.game.stage.scale.maxIterations = 1;

        if (this.game.device.android && this.game.device.chrome == false) {
            this.game.stage.scaleMode = Phaser.StageScaleMode.EXACT_FIT;
        }

        if (localStorage.getItem('labyrinth-progress') == null) {
            localStorage.setItem('labyrinth-progress', JSON.stringify([]));
            Main.progress = [];
        }
        else {
            Main.progress = JSON.parse(localStorage.getItem('labyrinth-progress'));
        }

        this.load.image('preloaderBar', 'assets/loaderFull.png');
    },
    create: function () {
        this.game.state.start('preloader');
    }
}

Main.Preloader = function (game) {
    this.game = game;
};

Main.Preloader.prototype =
{
    loaderFull: Phaser.Sprite,
    preload: function () {
        this.loaderFull = this.add.sprite(120, 450, 'preloaderBar');
        this.loaderFull.scale.x = 0.0;

        this.game.load.image('bg', 'assets/bg.png');
        this.game.load.image('logo', 'assets/logo.png');
        this.game.load.image('play', 'assets/play.png');
        this.game.load.image('accelneeded', 'assets/accelneeded.png');

        this.game.load.image('selectlevel', 'assets/selectlevel.png');
        this.game.load.image('lvl1', 'assets/lvl2.png');
        this.game.load.image('lvl2', 'assets/lvl1.png');
        this.game.load.image('lvl3', 'assets/lvl3.png');
        this.game.load.image('lvl4', 'assets/lvl4.png');
        this.game.load.image('lvl5', 'assets/lvl5.png');
        this.game.load.image('lvl6', 'assets/lvl6.png');
        this.game.load.image('lvl7', 'assets/lvl7.png');
        this.game.load.image('lvl8', 'assets/lvl8.png');
        this.game.load.image('lvl9', 'assets/lvl9.png');

        this.game.load.image('restart', 'assets/restart.png');
        this.game.load.image('exit', 'assets/exit.png');

        this.game.load.image('tutorial1', 'assets/tutorial1.png');
        this.game.load.image('tutorial2', 'assets/tutorial2.png');
        this.game.load.image('tutorial3', 'assets/tutorial3.png');

        this.game.load.image('ball', 'assets/ball.png');
        this.game.load.image('hole', 'assets/hole.png?2');
        this.game.load.image('goal', 'assets/goal.png?2');
        this.game.load.image('box1', 'assets/box1.png');
        this.game.load.image('box2', 'assets/box2.png');
        this.game.load.image('box3', 'assets/box3.png');
        this.game.load.image('box4', 'assets/box4.png');
        this.game.load.image('box5', 'assets/box5.png');
        this.game.load.image('box6', 'assets/box6.png');
        this.game.load.image('box7', 'assets/box7.png');
        this.game.load.image('box8', 'assets/box8.png');
        this.game.load.image('box9', 'assets/box9.png');
        this.game.load.image('box10', 'assets/box10.png');
        this.game.load.image('box11', 'assets/box11.png');
        this.game.load.image('box12', 'assets/box12.png');
        this.game.load.image('box13', 'assets/box13.png');
        this.game.load.image('box14', 'assets/box14.png');

        this.game.load.image('levelwon', 'assets/levelwon.png');
        this.game.load.image('next', 'assets/next.png');
        this.game.load.image('playagain', 'assets/playagain.png');
        this.game.load.image('menu', 'assets/menu.png');

        this.load.onFileComplete.add(this.fileLoaded, this);
    },
    create: function () {
        this.game.state.start('mainMenu');
    },
    fileLoaded: function (progress) {
        this.loaderFull.scale.x = progress / 100;
    }
}

Main.MainMenu = function (game) {
    this.game = game;
};

Main.MainMenu.prototype =
{
    bg: Phaser.Sprite,
    logo: Phaser.Sprite,
    play: Phaser.Button,
    group: Phaser.Group,

    create: function () {
        this.bg = this.game.add.sprite(0, 0, 'bg');

        this.group = this.game.add.group();
        this.group.alpha = 0;

        this.logo = this.game.add.sprite(70, 70, 'logo');

        this.group.add(this.bg);
        this.group.add(this.logo);

        if (gyro.getFeatures().length > 0) {
            this.play = this.game.add.button(320, 740, 'play');
            this.play.anchor = {x: 0.5, y: 0.5};
            this.play.orgWidth = 380;
            this.play.orgHeight = 110;

            this.play.onInputDown.add(this.buttonDown, this.play);
            this.play.onInputUp.add(this.playGame, this);
            this.input.onUp.add(this.buttonUp, this.play);

            this.group.add(this.play);
        }
        else {
            var needed = this.game.add.sprite(320, 740, 'accelneeded');
            needed.anchor = {x: 0.5, y: 0.5};
            this.group.add(needed);
        }

        var fade = this.game.add.tween(this.group);
        fade.to({alpha: 1}, 300);
        fade.start();
    },
    playGame: function () {
        var fade = this.game.add.tween(this.group);
        fade.to({alpha: 0}, 300);
        fade.start();

        var self = this;

        setTimeout(function () {
            self.game.state.start('levelSelect');
        }, 350);
    },
    buttonDown: function () {
        var bounce = this.game.add.tween(this);
        bounce.to({width: this.orgWidth * 1.1, height: this.orgHeight * 1.1}, 300, Phaser.Easing.Back.Out);
        bounce.start();
    },
    buttonUp: function () {
        var bounce = this.game.add.tween(this);
        bounce.to({width: this.orgWidth, height: this.orgHeight}, 300, Phaser.Easing.Back.Out);
        bounce.start();
    }
}

Main.LevelSelect = function (game) {
    this.game = game;
};

Main.LevelSelect.prototype =
{
    bg: Phaser.Sprite,
    caption: Phaser.Sprite,
    group: Phaser.Group,

    create: function () {
        this.group = this.game.add.group();
        this.group.alpha = 0;

        this.bg = this.game.add.sprite(0, 0, 'bg');
        this.group.add(this.bg);

        this.caption = this.game.add.sprite(120, 110, 'selectlevel');
        this.group.add(this.caption);

        for (var i = 0; i < 9; i++) {
            var lvl = this.game.add.button(190 + i * 130 - Math.floor(i / 3) * 390, 350 + Math.floor(i / 3) * 130, 'lvl' + (i + 1));
            lvl.anchor = {x: 0.5, y: 0.5};
            lvl.orgWidth = 100;
            lvl.orgHeight = 100;
            lvl.name = i;

            if (Main.progress.length >= i) {
                lvl.onInputDown.add(this.buttonDown, lvl);
                lvl.onInputUp.add(this.playGame, lvl);
                this.input.onUp.add(this.buttonUp, lvl);
            }
            else {
                lvl.alpha = 0.5;
                ;
                lvl.input.stop();
            }

            this.group.add(lvl);
        }

        this.exitButton = this.game.add.button(320, 850, 'exit');
        this.exitButton.scale = {x: 0.5, y: 0.5};
        this.exitButton.anchor = {x: 0.5, y: 0.5};
        this.exitButton.orgWidth = 128 * 0.5;
        this.exitButton.orgHeight = 128 * 0.5;

        this.exitButton.onInputDown.add(this.buttonDown, this.exitButton);
        this.exitButton.onInputUp.add(this.exitGame, this);
        this.input.onUp.add(this.buttonUp, this.exitButton);

        this.group.add(this.exitButton);

        var fade = this.game.add.tween(this.group);
        fade.to({alpha: 1}, 300);
        fade.start();
    },
    playGame: function () {
        var fade = this.game.add.tween(this.group);
        fade.to({alpha: 0}, 300);
        fade.start();

        Main.level = this.name;

        var self = this;

        setTimeout(function () {
            self.game.state.start('game');
        }, 350);
    },
    exitGame: function () {
        var fade = this.game.add.tween(this.group);
        fade.to({alpha: 0}, 300);
        fade.start();

        var self = this;

        setTimeout(function () {
            self.game.state.start('mainMenu');
        }, 350);
    },
    buttonDown: function () {
        var bounce = this.game.add.tween(this);
        bounce.to({width: this.orgWidth * 1.1, height: this.orgHeight * 1.1}, 300, Phaser.Easing.Back.Out);
        bounce.start();
    },
    buttonUp: function () {
        var bounce = this.game.add.tween(this);
        bounce.to({width: this.orgWidth, height: this.orgHeight}, 300, Phaser.Easing.Back.Out);
        bounce.start();
    }
}

Main.Game = function (game) {
    this.game = game;
};

Main.Game.prototype =
{
    bg: Phaser.Sprite,
    ball: Phaser.Sprite,
    holes: [],
    goal: Phaser.Sprite,
    group: Phaser.Group,
    uigroup: Phaser.Group,
    boxes: Phaser.Group,
    restartBtn: Phaser.Button,
    exitBtn: Phaser.Button,
    timeLabel: Phaser.Text,
    interval: null,
    map: [],
    playing: false,
    i: 0,

    create: function () {
        var levels = [
            {
                map: [
                    [07, 05, 05, 05, 05, 05, 05, 08],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 15, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [09, 05, 05, 05, 05, 05, 05, 10]
                ],
                start: {x: 150, y: 750},
                goal: {x: 80 * 2, y: 80 * 2},
                holes: []
            },
            {
                map: [
                    [07, 05, 05, 05, 12, 05, 05, 08],
                    [06, 00, 00, 00, 06, 00, 00, 06],
                    [06, 00, 15, 00, 04, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 15, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 02, 00, 00, 01, 13],
                    [06, 00, 00, 06, 00, 00, 00, 06],
                    [06, 00, 00, 06, 00, 00, 00, 06],
                    [06, 00, 00, 06, 00, 00, 00, 06],
                    [06, 00, 00, 06, 00, 00, 00, 06],
                    [09, 05, 05, 11, 05, 05, 05, 10]
                ],
                start: {x: 160, y: 750},
                goal: {x: 80 * 5, y: 80 * 9},
                holes: []
            },
            {
                map: [
                    [07, 05, 05, 05, 05, 05, 05, 08],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 15, 00, 00, 15, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 15, 00, 00, 15, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 15, 00, 00, 15, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [09, 05, 05, 05, 05, 05, 05, 10]
                ],
                start: {x: 320, y: 800},
                goal: {x: 280, y: 80 * 2},
                holes: []
            },
            {
                map: [
                    [07, 05, 05, 05, 05, 05, 05, 08],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [14, 05, 05, 05, 03, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 15, 00, 00, 00, 00, 06],
                    [06, 00, 00, 01, 05, 05, 05, 13],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [09, 05, 05, 05, 05, 05, 05, 10]
                ],
                start: {x: 160, y: 160},
                goal: {x: 80 * 5, y: 80 * 9},
                holes: [{x: 80 * 3, y: 80 * 1 + 10}, {x: 80 * 6 - 10, y: 80 * 3}]
            },
            {
                map: [
                    [07, 05, 05, 12, 05, 05, 05, 08],
                    [06, 00, 00, 06, 00, 00, 00, 06],
                    [06, 00, 00, 06, 00, 00, 00, 06],
                    [06, 00, 00, 06, 00, 00, 00, 06],
                    [06, 00, 00, 06, 00, 15, 00, 06],
                    [06, 00, 00, 06, 00, 00, 00, 06],
                    [06, 00, 00, 06, 00, 15, 00, 06],
                    [06, 00, 00, 06, 00, 00, 00, 06],
                    [06, 00, 00, 04, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [09, 05, 05, 05, 05, 05, 05, 10]
                ],
                start: {x: 120, y: 120},
                goal: {x: 80 * 5, y: 80 * 2},
                holes: [{x: 80 * 1 + 10, y: 80 * 3}, {x: 80 * 2 - 10, y: 80 * 5}, {
                    x: 80 * 1 + 10,
                    y: 80 * 7
                }, {x: 80 * 3, y: 80 * 10 - 10}]
            },
            {
                map: [
                    [07, 05, 05, 05, 05, 05, 05, 08],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 01, 05, 05, 05, 13],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [09, 05, 05, 05, 05, 05, 05, 10]
                ],
                start: {x: 500, y: 120},
                goal: {x: 80 * 6 - 10, y: 80 * 10 - 10},
                holes: [{x: 80 * 1 + 5, y: 80 * 4 + 20}, {x: 80 * 2 + 50, y: 80 * 4 + 20}, {
                    x: 80 * 5 - 30,
                    y: 80 * 10 - 10
                }, {x: 80 * 6 - 10, y: 80 * 9 - 30}]
            },
            {
                map: [
                    [07, 05, 05, 05, 05, 05, 05, 08],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 01, 05, 05, 05, 13],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 15, 00, 15, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [14, 05, 05, 05, 03, 00, 00, 06],
                    [06, 00, 00, 00, 00, 15, 00, 06],
                    [06, 00, 00, 15, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [09, 05, 05, 05, 05, 05, 05, 10]
                ],
                start: {x: 500, y: 120},
                goal: {x: 80 * 2 - 20, y: 80 * 9},
                holes: [{x: 80 * 1 + 5, y: 80 * 3}, {x: 80 * 3, y: 80 * 1 + 10}, {x: 80 * 5, y: 80 * 2 - 10}]
            },
            {
                map: [
                    [07, 05, 05, 05, 05, 05, 05, 08],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [14, 05, 05, 05, 03, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 01, 05, 05, 05, 13],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 15, 00, 15, 00, 00, 06],
                    [14, 00, 00, 15, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [09, 05, 05, 05, 05, 05, 05, 10]
                ],
                start: {x: 140, y: 160},
                goal: {x: 80 * 5, y: 80 * 9},
                holes: [{x: 80 * 3 - 50, y: 80 * 1 + 10}, {x: 80 * 3 - 50, y: 80 * 5 - 10}, {
                    x: 80 * 4,
                    y: 80 * 2 - 10
                }, {x: 80 * 4, y: 80 * 4 + 10}, {x: 80 * 6 - 10, y: 80 * 3}]
            },
            {
                map: [
                    [07, 05, 05, 05, 05, 05, 05, 08],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [06, 00, 00, 00, 00, 00, 00, 06],
                    [09, 05, 05, 05, 05, 05, 05, 10]
                ],
                start: {x: 320, y: 800},
                goal: {x: 280, y: 80 * 2},
                holes: [{x: 80 * 1 + 40, y: 80 * 4}, {x: 80 * 2 + 65, y: 80 * 4}, {
                    x: 80 * 3 + 90,
                    y: 80 * 4
                }, {x: 80 * 4 + 115, y: 80 * 4}, {x: 80 * 1 + 40, y: 80 * 6}, {
                    x: 80 * 2 + 65,
                    y: 80 * 6
                }, {x: 80 * 3 + 90, y: 80 * 6}, {x: 80 * 4 + 115, y: 80 * 6}, {
                    x: 80 * 1 + 40,
                    y: 80 * 8
                }, {x: 80 * 2 + 65, y: 80 * 8}, {x: 80 * 3 + 90, y: 80 * 8}, {x: 80 * 4 + 115, y: 80 * 8}]
            }
        ];

        this.playing = true;
        this.i = 0;

        this.map = levels[Main.level].map;
        this.holes = [];

        this.group = this.game.add.group();
        this.group.alpha = 0;

        this.boxes = this.game.add.group();
        this.boxes.alpha = 0;

        this.uigroup = this.game.add.group();
        this.uigroup.alpha = 0;

        this.bg = this.game.add.sprite(0, 0, 'bg');
        this.group.add(this.bg);

        if (Main.level == '0') {
            var tut1 = this.game.add.sprite(320, 480, 'tutorial1');
            tut1.anchor = {x: 0.5, y: 0.5};
            tut1.scale = {x: 0.75, y: 0.75};
            this.group.add(tut1);

            var tut2 = this.game.add.sprite(260, 190, 'tutorial2');
            tut2.scale = {x: 0.75, y: 0.75};
            this.group.add(tut2);

            var tut3 = this.game.add.sprite(260, 590, 'tutorial3');
            tut3.scale = {x: 0.75, y: 0.75};
            this.group.add(tut3);
        }

        for (var row = 0; row < this.map.length; row++) {
            for (var col = 0; col < this.map[row].length; col++) {
                if (this.map[row][col] > 0 && this.map[row][col] < 15) {
                    var box = this.game.add.sprite(80 * col, 80 * row, 'box' + this.map[row][col]);
                    box.scale = {x: 0.8, y: 0.8};
                    box.body.immovable = true;
                    this.boxes.add(box);
                }
                else if (this.map[row][col] == 15) {
                    var hole = this.game.add.sprite(80 * col, 80 * row, 'hole');
                    hole.scale = {x: 0.8, y: 0.8};
                    hole.body.immovable = true;
                    this.holes.push(hole);
                    this.group.add(hole);
                }
            }
        }

        for (var j = 0; j < levels[Main.level].holes.length; j++) {
            var hole = this.game.add.sprite(levels[Main.level].holes[j].x, levels[Main.level].holes[j].y, 'hole');
            hole.scale = {x: 0.8, y: 0.8};
            hole.body.immovable = true;
            this.holes.push(hole);
            this.group.add(hole);
        }

        this.goal = this.game.add.sprite(levels[Main.level].goal.x, levels[Main.level].goal.y, 'goal');
        this.goal.scale = {x: 0.8, y: 0.8};
        this.goal.body.immovable = true;
        this.group.add(this.goal);

        if (gyro.getFeatures().length > 0) {
            this.ball = this.game.add.sprite(levels[Main.level].start.x, levels[Main.level].start.y, 'ball');
            this.ball.scale = {x: 0.8, y: 0.8};
            this.ball.body.collideWorldBounds = true;
            this.ball.body.bounce = {x: 0.2, y: 0.2};
            this.ball.anchor = {x: 0.5, y: 0.5};
            this.group.add(this.ball);

            var self = this;

            gyro.frequency = 10;

            gyro.startTracking(function (o) {

                self.ball.body.velocity.x += o.x;
                self.ball.body.velocity.y -= o.y;
            });
        }

        this.restartButton = this.game.add.button(530, 920, 'restart');
        this.restartButton.scale = {x: 0.5, y: 0.5};
        this.restartButton.anchor = {x: 0.5, y: 0.5};
        this.restartButton.orgWidth = 128 * 0.5;
        this.restartButton.orgHeight = 128 * 0.5;

        this.restartButton.onInputDown.add(this.buttonDown, this.restartButton);
        this.restartButton.onInputUp.add(this.restartGame, this);
        this.input.onUp.add(this.buttonUp, this.restartButton);

        this.exitButton = this.game.add.button(600, 920, 'exit');
        this.exitButton.scale = {x: 0.5, y: 0.5};
        this.exitButton.anchor = {x: 0.5, y: 0.5};
        this.exitButton.orgWidth = 128 * 0.5;
        this.exitButton.orgHeight = 128 * 0.5;

        this.exitButton.onInputDown.add(this.buttonDown, this.exitButton);
        this.exitButton.onInputUp.add(this.exitGame, this);
        this.input.onUp.add(this.buttonUp, this.exitButton);

        this.uigroup.add(this.restartButton);
        this.uigroup.add(this.exitButton);

        var style = {font: '40px \'Arial Rounded MT Bold\'', fill: '#FFFFFF', align: 'left'};
        this.timeLabel = this.game.add.text(15, 900, 'Time: 0:00', style);
        this.uigroup.add(this.timeLabel);
        this.i = 0;

        var self = this;

        setTimeout(function () {
            self.interval = setInterval(function () {
                self.i++;
                self.timeLabel.destroy();
                self.timeLabel = self.game.add.text(15, 900, 'Time: ' + Math.floor(self.i / 100) + ':' + (Math.floor(self.i / 10) - Math.floor(self.i / 100) * 10) + (self.i - (Math.floor(self.i / 10) * 10)), style);
                self.uigroup.add(self.timeLabel);
            }, 10);
        }, 300);

        var fade = this.game.add.tween(this.group);
        fade.to({alpha: 1}, 300);
        fade.start();

        var fade2 = this.game.add.tween(this.boxes);
        fade2.to({alpha: 1}, 300);
        fade2.start();

        var fade3 = this.game.add.tween(this.uigroup);
        fade3.to({alpha: 1}, 300);
        fade3.start();
    },
    update: function () {
        if (this.ball != undefined && this.boxes != undefined && this.playing == true) {
            this.game.physics.collide(this.ball, this.boxes);

            for (var i = 0; i < this.holes.length; i++) {
                if (this.collides(this.ball.body, {
                        x: this.holes[i].body.x + 35,
                        y: this.holes[i].body.y + 35,
                        width: 10,
                        height: 10
                    })) {
                    this.playing = false;

                    gyro.stopTracking();
                    this.ball.body.velocity = {x: 0, y: 0};

                    var lose = this.game.add.tween(this.ball);
                    lose.to({
                        alpha: 0,
                        width: 40,
                        height: 40,
                        x: this.holes[i].body.x + 40,
                        y: this.holes[i].body.y + 40
                    }, 200);
                    lose.start();

                    this.restartGameDelay();
                }
            }

            if (this.collides(this.ball.body, {
                    x: this.goal.body.x + 30,
                    y: this.goal.body.y + 30,
                    width: 20,
                    height: 20
                })) {
                this.playing = false;

                gyro.stopTracking();
                this.ball.body.velocity = {x: 0, y: 0};

                var win = this.game.add.tween(this.ball);
                win.to({alpha: 0, width: 40, height: 40, x: this.goal.body.x + 40, y: this.goal.body.y + 40}, 200);
                win.start();

                this.wonGame();
            }
        }
    },
    collides: function (a, b) {
        if (a != undefined) {
            return !(
                ((a.y + a.height) < (b.y)) ||
                (a.y > (b.y + b.height)) ||
                ((a.x + a.width) < b.x) ||
                (a.x > (b.x + b.width))
            );
        }
    },
    wonGame: function () {
        clearInterval(this.interval);

        Main.time = this.i;
        console.log(Main.progress);
        if (Main.progress.length == parseInt(Main.level)) {
            Main.progress.push({time: this.i});
            localStorage.setItem('labyrinth-progress', JSON.stringify(Main.progress));
        }
        else {
            if (Main.progress[parseInt(Main.level)].time > this.i) {
                Main.progress[parseInt(Main.level)].time = this.i;
                localStorage.setItem('labyrinth-progress', JSON.stringify(Main.progress));
            }
        }

        var self = this;

        setTimeout(function () {
            self.closeGame();
            setTimeout(function () {
                self.game.state.start('won');
            }, 350);
        }, 200);
    },
    restartGame: function () {
        clearInterval(this.interval);
        gyro.stopTracking();

        this.closeGame();

        var self = this;

        setTimeout(function () {
            self.game.state.start('game');
        }, 350);
    },
    restartGameDelay: function () {
        clearInterval(this.interval);

        var self = this;

        setTimeout(function () {
            self.closeGame();

            setTimeout(function () {
                self.game.state.start('game');
            }, 350);
        }, 200);
    },
    exitGame: function () {
        clearInterval(this.interval);
        gyro.stopTracking();

        this.closeGame();

        var self = this;

        setTimeout(function () {
            self.game.state.start('levelSelect');
        }, 350);
    },
    closeGame: function () {
        var fade = this.game.add.tween(this.group);
        fade.to({alpha: 0}, 300);
        fade.start();

        var fade2 = this.game.add.tween(this.boxes);
        fade2.to({alpha: 0}, 300);
        fade2.start();

        var fade3 = this.game.add.tween(this.uigroup);
        fade3.to({alpha: 0}, 300);
        fade3.start();
    }
    , buttonDown: function () {
    var bounce = this.game.add.tween(this);
    bounce.to({width: this.orgWidth * 1.1, height: this.orgHeight * 1.1}, 300, Phaser.Easing.Back.Out);
    bounce.start();
},
    buttonUp: function () {
        var bounce = this.game.add.tween(this);
        bounce.to({width: this.orgWidth, height: this.orgHeight}, 300, Phaser.Easing.Back.Out);
        bounce.start();
    }
}

Main.Won = function (game) {
    this.game = game;
};

Main.Won.prototype =
{
    bg: Phaser.Sprite,
    caption: Phaser.Sprite,
    timeLabel: Phaser.Text,
    bestLabel: Phaser.Text,
    next: Phaser.Button,
    playagain: Phaser.Button,
    menu: Phaser.Button,
    group: Phaser.Group,

    create: function () {
        this.bg = this.game.add.sprite(0, 0, 'bg');

        this.caption = this.game.add.sprite(120, 150, 'levelwon');

        var i = Main.time;
        var j = Main.progress[parseInt(Main.level)].time;

        var style = {font: '40px \'Arial Rounded MT Bold\'', fill: '#684525', align: 'left'};
        this.timeLabel = this.game.add.text(80, 320, 'Time: ' + Math.floor(i / 100) + ':' + (Math.floor(i / 10) - Math.floor(i / 100) * 10) + (i - (Math.floor(i / 10) * 10)), style);
        this.bestLabel = this.game.add.text(360, 320, 'Best: ' + Math.floor(j / 100) + ':' + (Math.floor(j / 10) - Math.floor(j / 100) * 10) + (j - (Math.floor(j / 10) * 10)), style);

        this.next = this.game.add.button(320, 510, 'next');
        this.next.anchor = {x: 0.5, y: 0.5};
        this.next.orgWidth = 380;
        this.next.orgHeight = 110;

        this.next.onInputDown.add(this.buttonDown, this.next);
        this.next.onInputUp.add(this.nextGame, this);
        this.input.onUp.add(this.buttonUp, this.next);

        this.playagain = this.game.add.button(320, 630, 'playagain');
        this.playagain.anchor = {x: 0.5, y: 0.5};
        this.playagain.orgWidth = 380;
        this.playagain.orgHeight = 110;

        this.playagain.onInputDown.add(this.buttonDown, this.playagain);
        this.playagain.onInputUp.add(this.restartGame, this);
        this.input.onUp.add(this.buttonUp, this.playagain);

        this.menu = this.game.add.button(320, 750, 'menu');
        this.menu.anchor = {x: 0.5, y: 0.5};
        this.menu.orgWidth = 380;
        this.menu.orgHeight = 110;

        this.menu.onInputDown.add(this.buttonDown, this.menu);
        this.menu.onInputUp.add(this.gotoMenu, this);
        this.input.onUp.add(this.buttonUp, this.menu);

        this.group = this.game.add.group();
        this.group.alpha = 0;

        this.group.add(this.bg);
        this.group.add(this.caption);
        this.group.add(this.timeLabel);
        this.group.add(this.bestLabel);
        this.group.add(this.next);
        this.group.add(this.playagain);
        this.group.add(this.menu);

        var fade = this.game.add.tween(this.group);
        fade.to({alpha: 1}, 300);
        fade.start();
    },
    nextGame: function () {
        if ((parseInt(Main.level) + 1) < 9) {
            var fade = this.game.add.tween(this.group);
            fade.to({alpha: 0}, 300);
            fade.start();

            Main.level = (parseInt(Main.level) + 1) + '';

            var self = this;

            setTimeout(function () {
                self.game.state.start('game');
            }, 350);
        }
        else {
            this.gotoMenu();
        }
    },
    restartGame: function () {
        var fade = this.game.add.tween(this.group);
        fade.to({alpha: 0}, 300);
        fade.start();

        var self = this;

        setTimeout(function () {
            self.game.state.start('game');
        }, 350);
    },
    gotoMenu: function () {
        var fade = this.game.add.tween(this.group);
        fade.to({alpha: 0}, 300);
        fade.start();

        var self = this;

        setTimeout(function () {
            self.game.state.start('levelSelect');
        }, 350);
    },
    buttonDown: function () {
        var bounce = this.game.add.tween(this);
        bounce.to({width: this.orgWidth * 1.1, height: this.orgHeight * 1.1}, 300, Phaser.Easing.Back.Out);
        bounce.start();
    },
    buttonUp: function () {
        var bounce = this.game.add.tween(this);
        bounce.to({width: this.orgWidth, height: this.orgHeight}, 300, Phaser.Easing.Back.Out);
        bounce.start();
    }
}